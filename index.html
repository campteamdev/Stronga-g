<!DOCTYPE html>
<html lang="pl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mapa Kempingów</title>
    
    <!-- Style Leaflet i MarkerCluster -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
    
    <!-- Skrypty Leaflet i MarkerCluster -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fuse.js@7/dist/fuse.min.js"></script>
    <script src="custom-functions.js"></script>
    
    <style>
      body { margin: 0; padding: 0; }
      #map { width: 100%; height: 100vh; }
      #search-container {
        position: absolute;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        width: 70%;
        z-index: 1000;
      }
      #search-bar {
        display: flex;
        background-color: lightgray;
        border: 2px solid green;
        border-radius: 5px;
        padding: 5px;
        box-shadow: rgba(0, 0, 0, 0.3) 0 4px 10px;
      }
      #search-input {
        flex: 1;
        padding: 5px;
        border: none;
        font-size: 14px;
      }
      #search-button {
        background-color: green;
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 3px;
        cursor: pointer;
        margin-left: 5px;
      }
      #suggestions {
        background-color: white;
        border: 1px solid green;
        border-radius: 5px;
        max-height: 150px;
        overflow-y: auto;
        display: none;
      }
      .suggestion {
        padding: 10px;
        font-size: 14px;
        cursor: pointer;
        border-bottom: 1px solid #ddd;
      }
      .suggestion:hover { background-color: lightgreen; }
    </style>
  </head>
  <body>
    <div id="search-container">
      <div id="search-bar">
        <input type="text" id="search-input" placeholder="Znajdź obiekt..." />
        <button id="search-button">Szukaj</button>
      </div>
      <div id="suggestions"></div>
    </div>
    <div id="map"></div>
    
    <script>
      const map = L.map("map").setView([52.392681, 19.275023], 6);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "&copy; OpenStreetMap contributors",
      }).addTo(map);
      
      const markerCluster = L.markerClusterGroup();
      map.addLayer(markerCluster);
      const allMarkers = [];

      async function loadMarkers() {
        try {
          const response = await fetch("/Kempingi.kml");
          if (!response.ok) throw new Error("Błąd ładowania pliku KML");
          const kmlText = await response.text();
          const parser = new DOMParser();
          const kml = parser.parseFromString(kmlText, "application/xml");
          const placemarks = Array.from(kml.getElementsByTagName("Placemark"));
          
          placemarks.forEach((placemark) => {
            const name = placemark.getElementsByTagName("name")[0]?.textContent || "Brak nazwy";
            const coordinates = placemark.getElementsByTagName("coordinates")[0]?.textContent.trim();
            if (!coordinates) return;
            const [lon, lat] = coordinates.split(",");
            const marker = L.marker([lat, lon]).bindPopup(`<strong>${name}</strong>`);
            markerCluster.addLayer(marker);
            allMarkers.push({ name, lat, lon, marker });
          });
          console.log(`Załadowano ${allMarkers.length} markerów.`);
        } catch (error) {
          console.error("Błąd wczytywania KML:", error);
        }
      }

      function initializeSearch() {
        const searchInput = document.getElementById("search-input");
        const searchButton = document.getElementById("search-button");
        const suggestions = document.getElementById("suggestions");
        
        const fuse = new Fuse(allMarkers, { keys: ["name"], threshold: 0.3 });
        
        searchInput.addEventListener("input", () => {
          const query = searchInput.value.toLowerCase().trim();
          suggestions.innerHTML = "";
          if (!query) return;
          
          const results = fuse.search(query).slice(0, 5);
          results.forEach(({ item }) => {
            const suggestion = document.createElement("div");
            suggestion.className = "suggestion";
            suggestion.textContent = item.name;
            suggestion.addEventListener("click", () => {
              map.setView([item.lat, item.lon], 15);
              item.marker.openPopup();
              searchInput.value = item.name;
              suggestions.style.display = "none";
            });
            suggestions.appendChild(suggestion);
          });
          suggestions.style.display = results.length ? "block" : "none";
        });
        
        searchButton.addEventListener("click", () => {
          const query = searchInput.value.toLowerCase().trim();
          if (!query) return;
          
          const bestMatch = fuse.search(query)[0]?.item;
          if (bestMatch) {
            map.setView([bestMatch.lat, bestMatch.lon], 15);
            bestMatch.marker.openPopup();
          } else {
            alert("Nie znaleziono obiektu.");
          }
        });
      }
      
      loadMarkers().then(initializeSearch);
    </script>
  </body>
</html>
