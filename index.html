<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa Kemping√≥w</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
    
    <!-- Fuse.js do wyszukiwania -->
    <script src="https://cdn.jsdelivr.net/npm/fuse.js@7/dist/fuse.min.js"></script>
    
    <!-- Plik z funkcjami -->
    <script src="custom-functions.js"></script>

    <style>
        body { margin: 0; padding: 0; }
        #map { width: 100%; height: 100vh; }
        #search-container {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            width: 70%;
            z-index: 1000;
        }
        #search-bar {
            display: flex;
            flex-wrap: wrap;
            background-color: lightgray;
            border: 2px solid green;
            border-radius: 5px;
            padding: 5px;
            box-sizing: border-box;
            box-shadow: rgba(0, 0, 0, 0.3) 0 4px 10px;
        }
        #search-input {
            flex: 1;
            padding: 5px;
            border: none;
            outline: none;
            font-size: 14px;
            background-color: lightgray;
            border-radius: 3px;
            min-width: 0;
        }
        #search-button {
            background-color: green;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            margin-left: 5px;
            flex-shrink: 0;
        }
        #search-button:hover {
            background-color: darkgreen;
        }
        #suggestions {
            margin-top: 5px;
            background-color: white;
            border: 1px solid green;
            border-radius: 5px;
            max-height: 150px;
            overflow-y: auto;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            display: none;
        }
        .suggestion {
            padding: 10px;
            font-size: 14px;
            cursor: pointer;
            border-bottom: 1px solid #ddd;
        }
        .suggestion:last-child {
            border-bottom: none;
        }
        .suggestion:hover {
            background-color: lightgreen;
        }
    </style>
</head>
<body>

    <div id="search-container">
        <div id="search-bar">
            <input type="text" id="search-input" placeholder="Znajd≈∫ obiekt..." />
            <button id="search-button">Szukaj</button>
        </div>
        <div id="suggestions"></div>
    </div>

    <div id="map"></div>

    <script>
        console.log("üìå Skrypt startuje...");

        const map = L.map("map").setView([52.392681, 19.275023], 6);
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { attribution: "&copy; OpenStreetMap contributors" }).addTo(map);

        const allMarkers = [];
        const markerCluster = L.markerClusterGroup({ showCoverageOnHover: false, maxClusterRadius: 50 });
        
        async function loadMarkers() {
            console.log("üìç Wczytywanie marker√≥w...");
            
            // Za≈Çaduj markery (tu dodaj kod ≈Çadowania plik√≥w KML)
            
            console.log(`‚úÖ Za≈Çadowano ${allMarkers.length} marker√≥w.`);
        }

        function initializeSearch(attempt = 0) {
            console.log(`üìç Inicjalizacja wyszukiwania... Pr√≥ba ${attempt + 1}, Markery: ${allMarkers.length}`);

            if (allMarkers.length === 0) {
                if (attempt < 10) {
                    console.warn(`‚è≥ Markery nieza≈Çadowane, pr√≥bujƒô ponownie za 1 sek. (${attempt + 1}/10)`);
                    setTimeout(() => initializeSearch(attempt + 1), 1000);
                } else {
                    console.error("‚ùå Nie uda≈Ço siƒô za≈Çadowaƒá wyszukiwania.");
                }
                return;
            }

            console.log(`‚úÖ Wyszukiwanie gotowe. Markery: ${allMarkers.length}`);
        }

        async function initializeMap() {
            await loadMarkers();
            map.addLayer(markerCluster);
            initializeSearch();

            console.log("üîÑ Rozpoczynam wczytywanie szczeg√≥≈Ç√≥w dla popup√≥w...");
            if (typeof loadDetailsAndUpdatePopups === "function") {
                await loadDetailsAndUpdatePopups(allMarkers);
                console.log("‚úÖ Popupy zosta≈Çy za≈Çadowane.");
            } else {
                console.error("‚ùå B≈ÇƒÖd: Funkcja loadDetailsAndUpdatePopups() nie jest dostƒôpna.");
            }
        }

        initializeMap();

    </script>
</body>
</html>
