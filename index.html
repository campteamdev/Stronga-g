<script>
  const urls = {
    kempingi: "/Kempingi.kml",
    polanamiotowe: "/Polanamiotowe.kml",
    kempingiopen: "/Kempingiopen.kml",
    polanamiotoweopen: "/Polanamiotoweopen.kml",
    parkingilesne: "/Parkingilesne.kml",
    kempingi1: "/Kempingi1.kml",
    AtrakcjeKulturowe: "/AtrakcjeKulturowe.kml",
    AtrakcjePrzyrodnicze: "/AtrakcjePrzyrodnicze.kml",
    AtrakcjeRozrywkowe: "/AtrakcjeRozrywka.kml",
    miejscenabiwak: "/Miejscenabiwak.kml",
    europa: "/Europa.kml", // Dodajemy URL do pliku europa.kml
  };

  const icons = {
    kempingi: L.icon({
      iconUrl: "/ikony/Ikona_Kempingi_Polecane.png",
      iconSize: [40, 40],
      iconAnchor: [20, 20],
      popupAnchor: [0, -20],
    }),
    polanamiotowe: L.icon({
      iconUrl: "/ikony/Ikona_Pole_Namiotowe.png",
      iconSize: [40, 40],
      iconAnchor: [20, 20],
      popupAnchor: [0, -20],
    }),
    kempingiopen: L.icon({
      iconUrl: "/ikony/Ikona_Kempingi.png",
      iconSize: [30, 30],
      iconAnchor: [15, 15],
      popupAnchor: [0, -10],
    }),
    polanamiotoweopen: L.icon({
      iconUrl: "/ikony/Ikona_Pole_Namiotowe.png",
      iconSize: [30, 30],
      iconAnchor: [15, 15],
      popupAnchor: [0, -10],
    }),
    parkingilesne: L.icon({
      iconUrl: "/ikony/Ikona_Parking_Le%C5%9Bny.png",
      iconSize: [30, 30],
      iconAnchor: [15, 15],
      popupAnchor: [0, -10],
    }),
    kempingi1: L.icon({
      iconUrl: "/ikony/Ikona_Kempingi.png",
      iconSize: [30, 30],
      iconAnchor: [15, 15],
      popupAnchor: [0, -10],
    }),
    atractionCultural: L.icon({
      iconUrl: "/ikony/atractionCultural.png",
      iconSize: [35, 35],
      iconAnchor: [15, 15],
      popupAnchor: [0, -10],
    }),
    atractionFun: L.icon({
      iconUrl: "/ikony/atractionFun.png",
      iconSize: [35, 35],
      iconAnchor: [15, 15],
      popupAnchor: [0, -10],
    }),
    atractionNature: L.icon({
      iconUrl: "/ikony/atractionNature.png",
      iconSize: [35, 35],
      iconAnchor: [15, 15],
      popupAnchor: [0, -10],
    }),
    miejscenabiwak: L.icon({
      iconUrl: "/ikony/Ikona_Miejsce_Biwakowe.png",
      iconSize: [30, 30],
      iconAnchor: [15, 15],
      popupAnchor: [0, -10],
    }),
  };

  const map = L.map("map").setView([52.392681, 19.275023], 6);
  const markerCluster = L.markerClusterGroup({
    showCoverageOnHover: false,
    maxClusterRadius: 50,
  });

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution: "&copy; OpenStreetMap contributors",
  }).addTo(map);

  const addedMarkers = new Set();
  const allMarkers = [];
  const allPlacemarks = []; // Przechowywanie placemarks

  async function fetchKml(url) {
    const response = await fetch(url);
    if (!response.ok) throw new Error(`Błąd wczytywania pliku KML: ${url}`);
    return response.text();
  }

  async function loadMarkers(url, icon, addToCluster = true) {
    const kmlText = await fetchKml(url);
    const parser = new DOMParser();
    const kml = parser.parseFromString(kmlText, "application/xml");
    const placemarks = Array.from(kml.getElementsByTagName("Placemark"));
    allPlacemarks.push(...placemarks); // Dodanie placemarks do globalnej listy

    placemarks.forEach((placemark) => {
      const name =
        placemark.getElementsByTagName("name")[0]?.textContent || "Brak nazwy";
      const coordinates = placemark
        .getElementsByTagName("coordinates")[0]
        ?.textContent.trim();

      if (coordinates) {
        const [lon, lat] = coordinates.split(",");
        const key = `${lat},${lon}`;

        if (!addedMarkers.has(key)) {
          addedMarkers.add(key);
          const markerOptions = { icon };
          if (!addToCluster) {
            markerOptions.zIndexOffset = 9999; // Wyższy zIndex dla markerów poza grupowaniem
          }
          
          // Ustawienie popupu z szerokością
          const marker = L.marker([lat, lon], markerOptions).bindPopup(
            `<strong>${name}</strong>`,
            { minWidth: 200, maxWidth: 400 } // Określenie szerokości popupu
          );

          if (addToCluster) {
            markerCluster.addLayer(marker);
          } else {
            marker.addTo(map);
          }

          allMarkers.push({ marker, name, lat, lon });
        }
      }
    });
  }

  async function initializeMap() {
    await Promise.all([
      loadMarkers(urls.kempingi, icons.kempingi, false),
      loadMarkers(urls.polanamiotowe, icons.polanamiotowe, false),
      loadMarkers(urls.kempingiopen, icons.kempingiopen, false),
      loadMarkers(urls.polanamiotoweopen, icons.polanamiotoweopen, false),
      loadMarkers(urls.parkingilesne, icons.parkingilesne),
      loadMarkers(urls.kempingi1, icons.kempingi1, false),
      loadMarkers(urls.miejscenabiwak, icons.miejscenabiwak),
      loadMarkers(urls.europa, icons.kempingi), 
      loadMarkers(urls.AtrakcjeKulturowe, icons.atractionCultural),
      loadMarkers(urls.AtrakcjePrzyrodnicze, icons.atractionNature),
      loadMarkers(urls.AtrakcjeRozrywkowe, icons.atractionFun),
    ]);

    map.addLayer(markerCluster);
    initializeSearch();

    // Wywołanie funkcji z custom-functions.js
    await loadDetailsAndUpdatePopups(allMarkers, allPlacemarks);
  }

  initializeMap();
</script>
