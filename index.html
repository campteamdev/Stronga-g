<!DOCTYPE html>
<html lang="pl">
  <head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-MB2PNH4K2N"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-MB2PNH4K2N');
    </script>

    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mapa Kemping√≥w</title>

    <!-- ‚úÖ CSS powinien byƒá ≈Çadowany pierwszy -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.css" />
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="filters.css">

    <!-- ‚úÖ Skrypty zewnƒôtrzne (biblioteki) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fuzzball@2.1.3/dist/fuzzball.umd.min.js"></script>
    <script>window.fuzzball = fuzzball;</script>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

    <!-- ‚úÖ Swiper.js ≈Çadowany PO za≈Çadowaniu CSS -->
    <script src="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.js"></script>

    <!-- ‚úÖ Kluczowe skrypty - usuniƒôto `defer` -->
    <script src="encoded_kml.js"></script>
    <script src="custom-functions.js"></script>
  </head>
  <body onload="initializeMap()"> <!-- ‚úÖ Teraz mapa ≈Çaduje siƒô na pewno -->

  <!-- üîπ Ekran ≈Çadowania -->
<div id="loading-screen">
    <div class="loading-text">≈Åadowanie danych...</div>
</div>

  
  
  
  class="" oncontextmenu="return false;">
    <!-- Google Tag Manager (noscript) -->
    <noscript
      ><iframe
        src="https://www.googletagmanager.com/ns.html?id=GTM-W68222TL"
        height="0"
        width="0"
        style="display: none; visibility: hidden"
      ></iframe
    ></noscript>
    <!-- End Google Tag Manager (noscript) -->
    <div id="search-container">
      <div id="search-bar">
        <input type="text" id="search-input" placeholder="Znajd≈∫ obiekt..." />
        <button id="search-button">Szukaj</button>
      </div>
      <div id="suggestions"></div>
    </div>
    <div id="map">


    </button>

      <a
    href="https://www.facebook.com/profile.php?id=61567062909549&locale=pl_PL"
    target="_blank"
    class="facebook-button"
>
    <img src="/ikony/face.png" alt="Facebook"
         style="width: 40px; height: 40px;">
</a>

      <!-- <a
        href="https://www.campteam.pl/dodaj"
        target="_blank"
        class="link-button"
        >Dodaj miejsce na mapie</a
      > -->
      <a
        href="https://www.campteam.pl/dodaj"
        target="_blank"
        class="link-button-mobile"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
          class="lucide lucide-map-pin-plus-inside"
        >
          <path
            d="M20 10c0 4.993-5.539 10.193-7.399 11.799a1 1 0 0 1-1.202 0C9.539 20.193 4 14.993 4 10a8 8 0 0 1 16 0"
          />
          <path d="M12 7v6" />
          <path d="M9 10h6" />
        </svg>
      </a>
    </div>
    <script>
      const urls = {
        kempingi: "/Kempingi.kml",
        polanamiotowe: "/Polanamiotowe.kml",
        kempingiopen: "/Kempingiopen.kml",
        polanamiotoweopen: "/Polanamiotoweopen.kml",
        parkingilesne: "/Parkingilesne.kml",
        kempingi1: "/Kempingi1.kml",
        AtrakcjeKulturowe: "/AtrakcjeKulturowe.kml",
        AtrakcjePrzyrodnicze: "/AtrakcjePrzyrodnicze.kml",
        AtrakcjeRozrywka: "/AtrakcjeRozrywka.kml",
        miejscenabiwak: "/Miejscenabiwak.kml",
        europa: "/Europa.kml", // Dodajemy URL do pliku europa.kml
      };

      const icons = {
        kempingi: L.icon({
          iconUrl: "/ikony/Ikona_Kempingi_Polecane.png",
          iconSize: [40, 40],
          iconAnchor: [20, 20],
          popupAnchor: [0, -20],
        }),
        polanamiotowe: L.icon({
          iconUrl: "/ikony/Ikona_Pole_Namiotowe.png",
          iconSize: [40, 40],
          iconAnchor: [20, 20],
          popupAnchor: [0, -20],
        }),
        kempingiopen: L.icon({
          iconUrl: "/ikony/Ikona_Kempingi.png",
          iconSize: [30, 30],
          iconAnchor: [15, 15],
          popupAnchor: [0, -10],
        }),
        polanamiotoweopen: L.icon({
          iconUrl: "/ikony/Ikona_Pole_Namiotowe.png",
          iconSize: [40, 40],
          iconAnchor: [15, 15],
          popupAnchor: [0, -10],
        }),
        parkingilesne: L.icon({
          iconUrl: "/ikony/Ikona_Parking_Le%C5%9Bny.png",
          iconSize: [30, 30],
          iconAnchor: [15, 15],
          popupAnchor: [0, -10],
        }),
        kempingi1: L.icon({
          iconUrl: "/ikony/Ikona_Kempingi.png",
          iconSize: [30, 30],
          iconAnchor: [15, 15],
          popupAnchor: [0, -10],
        }),
        atractionCultural: L.icon({
          iconUrl: "/ikony/atractionCultural.png",
          iconSize: [35, 35],
          iconAnchor: [15, 15],
          popupAnchor: [0, -10],
        }),
        atractionFun: L.icon({
          iconUrl: "/ikony/atractionFun.png",
          iconSize: [35, 35],
          iconAnchor: [15, 15],
          popupAnchor: [0, -10],
        }),
        atractionNature: L.icon({
          iconUrl: "/ikony/atractionNature.png",
          iconSize: [35, 35],
          iconAnchor: [15, 15],
          popupAnchor: [0, -10],
        }),
        miejscenabiwak: L.icon({
          iconUrl: "/ikony/Ikona_Miejsce_Biwakowe.png",
          iconSize: [30, 30],
          iconAnchor: [15, 15],
          popupAnchor: [0, -10],
        }),
      };


      const map = L.map("map").setView([52.392681, 19.275023], 6);
      const markerCluster = L.markerClusterGroup({
        showCoverageOnHover: false,
        maxClusterRadius: 50,
      });

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "&copy; OpenStreetMap contributors",
      }).addTo(map);

      const addedMarkers = new Set();
      const allMarkers = [];
      const allPlacemarks = []; // Przechowywanie placemarks

      async function fetchKml(filename) {
  const token = await generateToken(filename); // ‚úÖ Czekamy na token
  const url = `https://campteam-9l04l41bs-marcincamps-projects.vercel.app/api/kml?id=${filename}&token=${token}`;



  const response = await fetch(url);
  if (!response.ok) throw new Error(`‚ùå B≈ÇƒÖd wczytywania pliku KML: ${url}`);

  return response.text();
}


async function loadMarkers(filename, icon, addToCluster = true) {
    const kmlText = await fetchKml(filename);

    const parser = new DOMParser();
    const kml = parser.parseFromString(kmlText, "application/xml");
    const placemarks = Array.from(kml.getElementsByTagName("Placemark"));
    allPlacemarks.push(...placemarks); // Dodanie placemarks do globalnej listy

    placemarks.forEach((placemark) => {
        const name =
            placemark.getElementsByTagName("name")[0]?.textContent ||
            "Brak nazwy";
        const coordinates = placemark
            .getElementsByTagName("coordinates")[0]
            ?.textContent.trim();

        if (coordinates) {
            const [lon, lat] = coordinates.split(",");
            const key = `${lat},${lon}`;

            if (!addedMarkers.has(key)) {
                addedMarkers.add(key);
                const markerOptions = { icon };
                if (!addToCluster) {
                    markerOptions.zIndexOffset = 9999; // Wy≈ºszy zIndex dla marker√≥w poza grupowaniem
                }

                // üîπ Tworzymy marker i ustawiamy `isDataLoaded = false` 
                const marker = L.marker([lat, lon], markerOptions);
                marker.isDataLoaded = false; // ‚ùå Blokujemy otwieranie popupu przed za≈Çadowaniem danych

                // üîπ Dodajemy marker do klastra lub mapy
                if (addToCluster) {
                    markerCluster.addLayer(marker);
                } else {
                    marker.addTo(map);
                }

                // üîπ Obs≈Çuga klikniƒôcia ‚Äì popup otworzy siƒô dopiero po za≈Çadowaniu danych
                marker.on("click", function () {
                    moveMapAndOpenPopup(marker);
                });

                allMarkers.push({ marker, name, lat, lon });
            }
        }
    });
}


      function initializeSearch() {
    const searchInput = document.getElementById("search-input");
    const searchButton = document.getElementById("search-button");
    const suggestions = document.getElementById("suggestions");

    let showAll = false; // Czy pokazujemy wiƒôcej wynik√≥w?

    searchInput.addEventListener("input", () => {
        const query = searchInput.value.toLowerCase().trim();
        suggestions.innerHTML = "";
        if (!query) {
            suggestions.style.display = "none";
            return;
        }

        let matches = allMarkers.map((m) => ({
            marker: m.marker,
            name: m.name,
            lat: m.lat,
            lon: m.lon,
            score: fuzzball.token_set_ratio(query, m.name) // Obliczanie podobie≈Ñstwa
        }));

        // Sortujemy wyniki wed≈Çug podobie≈Ñstwa
        matches.sort((a, b) => b.score - a.score);

        // Liczba wynik√≥w do wy≈õwietlenia (4 domy≈õlnie, 10 po klikniƒôciu "Poka≈º wiƒôcej")
        const resultsToShow = showAll ? 10 : 4;
        matches = matches.slice(0, resultsToShow);

        matches.forEach((match) => {
            const suggestion = document.createElement("div");
            suggestion.className = "suggestion";
            suggestion.textContent = match.name;
            suggestion.addEventListener("click", () => {
                highlightMarker(match); // Pod≈õwietlenie markera
                map.setView([match.lat, match.lon], 15);
                match.marker.openPopup();
                suggestions.style.display = "none";
                searchInput.value = match.name;
            });
            suggestions.appendChild(suggestion);
        });

        // Dodanie przycisku "Poka≈º wiƒôcej" je≈õli jest wiƒôcej wynik√≥w
        if (!showAll && allMarkers.length > 4) {
            const showMoreBtn = document.createElement("div");
            showMoreBtn.className = "suggestion show-more";
            showMoreBtn.textContent = "Poka≈º wiƒôcej...";
            showMoreBtn.addEventListener("click", () => {
                showAll = true;
                searchInput.dispatchEvent(new Event("input")); // Od≈õwie≈ºenie wynik√≥w
            });
            suggestions.appendChild(showMoreBtn);
        }

        suggestions.style.display = matches.length > 0 ? "block" : "none";
    });

    searchButton.addEventListener("click", () => {
        const query = searchInput.value.toLowerCase().trim();
        if (!query) return;

        let matches = allMarkers.map((m) => ({
            marker: m.marker,
            name: m.name,
            lat: m.lat,
            lon: m.lon,
            score: fuzzball.token_set_ratio(query, m.name)
        }));

        matches.sort((a, b) => b.score - a.score);
        const bestMatch = matches[0];

        if (bestMatch && bestMatch.score > 60) { // Je≈õli wynik dopasowania jest dobry
            highlightMarker(bestMatch);
            map.setView([bestMatch.lat, bestMatch.lon], 15);
            bestMatch.marker.openPopup();
        } else {
            alert("Nie znaleziono obiektu.");
        }
    });
}

// üîπ Funkcja pod≈õwietlajƒÖca marker (zmienia ikonƒô na wiƒôkszƒÖ na chwilƒô)
function highlightMarker(match) {
    const originalIcon = match.marker.options.icon;

    const highlightIcon = L.icon({
        iconUrl: "/ikony/highlight.png", // Dodaj specjalnƒÖ ikonƒô pod≈õwietlenia
        iconSize: [50, 50], 
        iconAnchor: [25, 25],
        popupAnchor: [0, -25]
    });

    match.marker.setIcon(highlightIcon);

    setTimeout(() => {
        match.marker.setIcon(originalIcon);
    }, 1500);
}
function attachMarkerClickEvents() {
    

    // üîπ Przechodzimy przez wszystkie markery w klastrze
    markerCluster.eachLayer(layer => {
        if (layer instanceof L.Marker) {
     
            layer.off("click");
            layer.on("click", function () {
                moveMapAndOpenPopup(this);
            });
        }
    });

    // üîπ Przechodzimy przez pojedyncze markery dodane bezpo≈õrednio do mapy
    allMarkers.forEach(({ marker }) => {
        if (!markerCluster.hasLayer(marker)) { // Sprawdzamy, czy marker NIE jest w klastrze
           
            marker.off("click");
            marker.on("click", function () {
                moveMapAndOpenPopup(this);
            });
        }
    });
}

// üîπ Wywo≈Çaj po za≈Çadowaniu wszystkich marker√≥w
async function initializeMap() {
    console.log("üîÑ [initializeMap] Rozpoczynam ≈Çadowanie mapy...");

    // ‚úÖ Poka≈º ekran ≈Çadowania
    document.getElementById("loading-screen").style.display = "flex";
    document.getElementById("loading-screen").style.opacity = "1";

    // üîπ **≈Åadowanie kluczowych plik√≥w KML (bez grupowania)**
    const coreFiles = [
        { filename: "Kempingi.kml", icon: icons.kempingi, addToCluster: false },
        { filename: "Polanamiotowe.kml", icon: icons.polanamiotowe, addToCluster: false }
    ];

    // üîπ **≈Åadowanie pozosta≈Çych plik√≥w KML (grupowane)**
    const groupedFiles = [
        { filename: "Kempingiopen.kml", icon: icons.kempingiopen, addToCluster: true },
        { filename: "Polanamiotoweopen.kml", icon: icons.polanamiotoweopen, addToCluster: true },
        { filename: "Kempingi1.kml", icon: icons.kempingi1, addToCluster: true },
        { filename: "Miejscenabiwak.kml", icon: icons.miejscenabiwak, addToCluster: true },
        { filename: "AtrakcjeKulturowe.kml", icon: icons.atractionCultural, addToCluster: true },
        { filename: "AtrakcjePrzyrodnicze.kml", icon: icons.atractionNature, addToCluster: true },
        { filename: "AtrakcjeRozrywka.kml", icon: icons.atractionFun, addToCluster: true }
    ];

    // üîπ **≈Åadowanie dodatkowych plik√≥w w tle (grupowane)**
    const additionalFiles = [
        { filename: "Europa.kml", icon: icons.kempingi, addToCluster: true },
        { filename: "Parkingilesne.kml", icon: icons.parkingilesne, addToCluster: true }
    ];

    // üî• **≈Åadujemy kluczowe pliki KML jako pierwsze (szybkie uruchomienie mapy)**
    await Promise.all(coreFiles.map(file => loadMarkers(file.filename, file.icon, file.addToCluster)));

    console.log("‚úÖ [initializeMap] Kempingi i Pola namiotowe za≈Çadowane.");

    // ‚úÖ **Wczytujemy szczeg√≥≈Çy i popupy dla Kemping√≥w i P√≥l namiotowych**
    await loadDetailsAndUpdatePopups(allMarkers, allPlacemarks);
    await generateAllPopups();

    // ‚úÖ **Teraz dodajemy markery Kemping√≥w i P√≥l namiotowych do mapy**
    map.addLayer(markerCluster);
    attachMarkerClickEvents();
    initializeSearch();

    console.log("‚úÖ [initializeMap] Podstawowe warstwy gotowe!");

    // ‚úÖ **Ukrycie ekranu ≈Çadowania (animacja zanikania)**
    document.getElementById("loading-screen").style.opacity = "0";
    setTimeout(() => {
        document.getElementById("loading-screen").style.display = "none";
    }, 500);

    // üî• **W tle r√≥wnocze≈õnie ≈Çadujemy resztƒô plik√≥w KML**
    console.log("‚è≥ [initializeMap] ≈Åadowanie pozosta≈Çych warstw KML...");
    await Promise.all(groupedFiles.map(file => loadMarkers(file.filename, file.icon, file.addToCluster)));
    console.log("‚úÖ [initializeMap] Pozosta≈Çe pliki KML za≈Çadowane.");

    // ‚úÖ **Ponowne generowanie popup√≥w (dla reszty plik√≥w)**
    await generateAllPopups();

    // üî• **Dodatkowe pliki KML ≈Çadowane w tle**
    additionalFiles.forEach(({ filename, icon }, index) => {
        setTimeout(async () => {
            await loadMarkers(filename, icon, true);
            console.log(`‚úÖ [initializeMap] ${filename} za≈Çadowane.`);
        }, index * 1000);
    });

    // üîπ **Zapobieganie zamykaniu popup√≥w na telefonach**
    document.addEventListener("touchstart", function (event) {
        if (event.target.closest(".leaflet-popup-content")) {
            event.stopPropagation(); // ‚úÖ Pozw√≥l na interakcjƒô z popupem
        }
    }, { passive: false });

    // üîπ **Wymuszenie pe≈Çnoekranowych popup√≥w na telefonach**
    map.on("popupopen", function (e) {
        if (window.innerWidth <= 768) {
            const popupWrapper = e.popup._container;
            if (popupWrapper) {
                popupWrapper.style.position = "fixed";
                popupWrapper.style.width = "100vw";
                popupWrapper.style.height = "100vh";
                popupWrapper.style.top = "0";
                popupWrapper.style.left = "0";
                popupWrapper.style.transform = "none";
                popupWrapper.style.borderRadius = "0";
                popupWrapper.style.overflow = "auto";
                popupWrapper.style.zIndex = "10000";
                popupWrapper.style.background = "white";
            }
        }
    });

    console.log("‚úÖ [initializeMap] Mapa w pe≈Çni za≈Çadowana!");
}




const popupCache = {}; // Pamiƒôƒá podrƒôczna dla gotowych popup√≥w

async function generateAllPopups() {
 

    for (const { marker, name, lat, lon } of allMarkers) {
        if (!popupCache[name]) {
            // ‚úÖ Generujemy tre≈õƒá popupu i zapisujemy w cache
            popupCache[name] = generatePopupContent(name, lat, lon);
        }

        // ‚úÖ Przypisujemy gotowy popup do markera (zamiast generowaƒá go dynamicznie)
        marker.bindPopup(popupCache[name], { autoPan: true, minWidth: 200 });
    }

 
}



// Blokowanie kopiowania na wszystkich urzƒÖdzeniach (Windows, Mac, iPhone, Android)
document.addEventListener("copy", (event) => {
  event.preventDefault();
  alert("Kopiowanie jest zablokowane!");
});
document.addEventListener("cut", (event) => {
  event.preventDefault();
  alert("Wycinanie jest zablokowane!");
});
document.addEventListener("paste", (event) => {
  event.preventDefault();
});
document.addEventListener("selectstart", (event) => {
  event.preventDefault();
});
document.addEventListener("contextmenu", (event) => {
  event.preventDefault();
});

document.addEventListener("touchstart", function (event) {
    if (event.target.closest(".leaflet-popup-content")) {
        event.stopPropagation(); // ‚úÖ Pozw√≥l na interakcjƒô z popupem
    }
}, { passive: false });

initializeMap();

    </script>








<script src="image-loader.js"></script>

<!-- üîπ Panel wysuwanego popupu -->
<div id="custom-popup">
  <span id="close-popup">&times;</span> <!-- Przycisk zamkniƒôcia -->
  <div id="custom-popup-content"></div> <!-- Tu bƒôdƒÖ tre≈õci -->
</div>







<script>
  document.addEventListener("DOMContentLoaded", function () {
      const searchContainer = document.getElementById("search-container");
  
      map.on("popupopen", function () {
          if (window.innerWidth <= 768) {
              console.log("üìå [popupopen] Ukrywanie wyszukiwarki...");
              searchContainer.style.display = "none";
          }
      });
  
      map.on("popupclose", function () {
          if (window.innerWidth <= 768) {
              console.log("üìå [popupclose] Przywracanie wyszukiwarki...");
              searchContainer.style.display = "block";
          }
      });
  });
  </script>
  

</body> 
</html>